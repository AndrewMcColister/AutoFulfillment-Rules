package com.delta.rm.bre.autofulfillment.rules;

import com.delta.rm.bre.autofulfillment.model.*;
import java.util.List;

// Rule 1: Coupon Status No Show
rule "IE_Doc_Row1_CouponStatusNoShow"
    salience 1010
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum )
    $coupon : Coupon( couponStateCode == "Sold", couponStatusCode in ("2") ) from $accDoc.getCouponList().getCoupons()
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to No Show"),
        setReasonCode("CE_FF_233")
    }
end

// Rule 2: Award Loyalty Tier
rule "IE_Doc_Row2_AwardLoyaltyTier"
    salience 1000
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $redeemer : RedeemerLoyalty( isNegateFulfillment != true )
    $accDoc : AccountableDocument( documentCategoryCode == "T", documentConnectionTypeCode == "AWD" )
then
    modify($redeemer) {
        setIsNegateFulfillment(true)
    }
end

// Rule 3: Exclude Voucher FOP with residual value
rule "IE_Doc_Row3_VoucherFOPResidual"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $exTxnSum : exchangedTransactionSummary )
    ExchangedTransactionSummary( dtvResult == true || eGiftCardResult == true || enciResult == true || mcoResult == true || refundResult == true ) from $exTxnSum
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("FoP is a voucher with residual value"),
        setReasonCode("CE_FF_244")
    }
end

// Rule 4: Exclude OA Control
rule "IE_Doc_Row4_OAControl"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, accountableDocumentNum matches "(006)[0-9]{10}" )
    $coupon : Coupon( couponStateCode == "Sold", couponStatusCode in ("A") ) from $accDoc.getCouponList().getCoupons()
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Airport Control with OA carrier"),
        setReasonCode("CE_FF_243")
    }
end

// Rule 5: Exclude Document as FOP
rule "IE_Doc_Row5_DocumentAsFOP"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentConnectionTypeCode not in ("AWD"), exchangedTransactionSummary != null )
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false", waiverRemark == "false", cancelStatus == "true", voluntaryExchangeType == "true" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible because document is used as a FOP"),
        setReasonCode("CE_FF_238")
    }
end

// Rule 6: Invalid Loyalty Account Status
rule "IE_Doc_Row6_InvalidLoyaltyStatus"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    RedeemerLoyalty( isNegateFulfillment == true, loyaltyRestrictionCode == "Y" || loyaltyStatusCode in ("CN", "DD", "CN/DD") )
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum )
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == "true" || fulfillable == null )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Invalid Loyalty Account Status"),
        setReasonCode("CE_FF_237")
    }
end

// Rule 7: Exclude MCO 270 form
rule "IE_Doc_Row7_MCO270Form"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $exTxnSum : exchangedTransactionSummary )
    $exDoc : ExchangedAccountableDocument( exchangedDocNum != null, exchangedDocNum.length() >= 6, exchangedDocNum.substring(3, 6) == "270" ) from $exTxnSum.exchangedAccountableDocuments
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to MCO being used as a FOP"),
        setReasonCode("CE_FF_236")
    }
end

// Rule 8: Invalid Ticket Designator
rule "IE_Doc_Row8_InvalidTicketDesignator"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum )
    $coupon : Coupon( couponStateCode == "Sold", fareBasisTicketDesignatorCode != null, fareBasisTicketDesignatorCode matches ".*/.*(C2|C3|C4|C5|C6|JE|GN|GR|JN|AN|CQ|BC|BN).*" ) from $accDoc.getCouponList().getCoupons()
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false", voluntaryExchangeType == "true" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to ticket designator code"),
        setReasonCode("CE_FF_231")
    }
end

// Rule 9-12: EMD Mixed Currency (simplified - full implementation would check currency mismatches)
rule "IE_Doc_Row9_EMDMixedCurrency"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentCategoryCode not in ("T"), $amounts : amounts )
    // Note: Full mixed currency validation requires checking currency codes across amounts
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    // This rule should be enhanced with proper currency validation logic
end

// Rule 13: Exclude Mileage Payment DC Channel PWM
rule "IE_Doc_Row13_MileagePaymentDC"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    ChannelInfo( channelId in ("DC") )
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentConnectionTypeCode == "AWD", $amounts : amounts )
    $amt : Amount( amountTypeCode == "TotalAmount", $price : amount ) from $amounts
    MilesEquivalentPrice( cashPlusMiles == true ) from $price.milesEquivalentPrice
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible for Mileage Payment when ticket is Cash Plus Miles - Special Handling"),
        setReasonCode("CE_FF_217")
    }
end

// Rule 14: Exclude Multi Reissue Exchange
rule "IE_Doc_Row14_MultiReissueExchange"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, exchange == "Y" )
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible because ticket is multi reissue exchange"),
        setReasonCode("CE_FF_211")
    }
end

// Rule 15: Exclude Mileage Payment Non-DC Channel PWM
rule "IE_Doc_Row15_MileagePaymentNonDC"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    ChannelInfo( channelId not in ("DC") )
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentConnectionTypeCode == "AWD", $amounts : amounts )
    $amt : Amount( amountTypeCode == "TotalAmount", $price : amount ) from $amounts
    MilesEquivalentPrice( cashPlusMiles == true ) from $price.milesEquivalentPrice
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible for Mileage Payment when ticket is Cash Plus Miles - Generic Handling"),
        setReasonCode("CE_FF_210")
    }
end

// Rule 16: Exclude Pay With Miles
rule "IE_Doc_Row16_PayWithMiles"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentConnectionTypeCode in ("PIF", "PIP", "PMF", "PMP") )
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible for Pay With Miles"),
        setReasonCode("CE_FF_209")
    }
end

// Rule 17: SkyMiles Validation
rule "IE_Doc_Row17_SkyMilesValidation"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentConnectionTypeCode == "AWD", $lmr : loyaltyMilesRedemption )
    LoyaltyMilesRedemption( redemptionCertificateNum == null || redemptionCertificateNum == "" ) from $lmr
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Error - missing SkyMiles certificate number for award ticket"),
        setReasonCode("CE_FF_208")
    }
end

// Rule 18-21: Exclude Split Ticket Endorsements V, X, Y, Z
rule "IE_Doc_Row18_SplitTicketV"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $endorsements : couponEndorsements )
    CouponEndorsement( endorsementText == "V" ) from $endorsements
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to split ticket (endorsement V)"),
        setReasonCode("CE_FF_205")
    }
end

rule "IE_Doc_Row19_SplitTicketX"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $endorsements : couponEndorsements )
    CouponEndorsement( endorsementText == "X" ) from $endorsements
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to split ticket (endorsement X)"),
        setReasonCode("CE_FF_205")
    }
end

rule "IE_Doc_Row20_SplitTicketY"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $endorsements : couponEndorsements )
    CouponEndorsement( endorsementText == "Y" ) from $endorsements
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to split ticket (endorsement Y)"),
        setReasonCode("CE_FF_205")
    }
end

rule "IE_Doc_Row21_SplitTicketZ"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, $endorsements : couponEndorsements )
    CouponEndorsement( endorsementText == "Z" ) from $endorsements
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum, fulfillable == null, rfcEligible == "false" )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Ineligible due to split ticket (endorsement Z)"),
        setReasonCode("CE_FF_205")
    }
end

// Rule 22: Exclude EMD Y,M,D for DC Channel
rule "IE_Doc_Row22_EMD_YMD_DC"
    salience 0
    no-loop true
    ruleflow-group "Fulfillment_InEligible_Document"
    dialect "mvel"
when
    ChannelInfo( channelId in ("DC") )
    $accDoc : AccountableDocument( $accDocNum : accountableDocumentNum, documentCategoryCode in ("D", "M", "Y") )
    $ctx : AccountableDocumentContextWrapper( accountableDocumentNum == $accDocNum )
then
    modify($ctx) {
        setFulfillable("false"),
        setFulfillabilityReason("Channel not allowed to refund EMD (EMDPlus and eFee)"),
        setReasonCode("CE_FF_201")
    }
end
